<!DOCTYPE html>
<!--
  This file is part of LoveCall.

  LoveCall is free software: you can redistribute it and/or modify
  it under the terms of the GNU General Public License as published by
  the Free Software Foundation, either version 3 of the License, or
  (at your option) any later version.

  LoveCall is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU General Public License for more details.

  You should have received a copy of the GNU General Public License
  along with LoveCall.  If not, see <http://www.gnu.org/licenses/>.
-->
<html lang="en">
<head>
	<meta charset="utf-8" />
	<title>ラブコール</title>
</head>
<body>
  <audio
      id="music-source"
      controls="controls"
      >
    <source src="snowhare.mp3" type="audio/mp3" />
  </audio>

  <p id="offset"></p>

  <p id="measure"></p>
  <p id="beat"></p>

<script>
(function(document, window, undefined) {
  'use strict';

  // rhythm
  var offsetMs = 812;
  var beatMs = 346.820809248555;
  var tempoFactory = function(beatMs, offsetMs) {
    // TODO: 4/4 time signature assumed
    var measureMs = beatMs * 4;

    return function(posMs) {
      var posAfterOffset = posMs - offsetMs;
      var tmp = posAfterOffset / measureMs;
      var measure = Math.floor(tmp);
      var beat = Math.floor((posAfterOffset - measure * measureMs) / beatMs);
      return {
        'measure': measure,
        'beat': beat
      };
    };
  };

  var snowhareTempo = tempoFactory(beatMs, offsetMs);

  // DOM
  var sourceElement = document.getElementById('music-source');
  var offsetElement = document.getElementById('offset');
  var measureElement = document.getElementById('measure');
  var beatElement = document.getElementById('beat');
  //sourceElement.addEventListener('timeupdate', function(e) {
    // offsetElement.innerHTML = '' + e.target.currentTime;
    //console.log(e.target.currentTime);
  //});

  var isPlaying = false;
  var playEventHandlerFactory = function(newState) {
    return function(e) {
      isPlaying = newState;
    };
  };

  sourceElement.addEventListener('play', playEventHandlerFactory(true));
  sourceElement.addEventListener('playing', playEventHandlerFactory(true));
  sourceElement.addEventListener('pause', playEventHandlerFactory(false));

  var audioCallback = function(posMs) {
    var currentBeat = snowhareTempo(posMs);

    offsetElement.innerHTML = '' + posMs;
    measureElement.innerHTML = '' + currentBeat['measure'];
    beatElement.innerHTML = '' + currentBeat['beat'];
  };

  var frameCallback = function(ts) {
    var posMs = sourceElement.currentTime * 1000;

    if (isPlaying) {
      audioCallback(posMs);
    }

    window.requestAnimationFrame(frameCallback);
  };

  window.requestAnimationFrame(frameCallback);
})(document, window);
</script>
<!-- vim:set ai et ts=2 sw=2 sts=2 fenc=utf-8: -->
</body>
</html>
